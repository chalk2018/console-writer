Object.defineProperty(exports,"__esModule",{value:!0}),exports.auto=exports.ConsoleBuilder=exports.Level=void 0;const log4js=require("log4js"),path=require("path"),consoleProperty={log:!0,info:!0,error:!0,exception:!0,warn:!0,debug:!0,assert:!1,clear:!1,context:!1,count:!1,countReset:!1,dir:!1,dirxml:!1,group:!1,groupCollapsed:!1,groupEnd:!1,memory:!1,profile:!1,profileEnd:!1,table:!1,time:!1,timeEnd:!1,timeLog:!1,timeStamp:!1,trace:!1},{configure,getLogger}=log4js;var Level;!function(e){e.all="all",e.debug="debug",e.info="info",e.warn="warn",e.error="error",e.off="off"}(Level=exports.Level||(exports.Level={}));const defaultOption={backup:!0,fileName:"console.log",logDir:"logs",backupSize:10485760,backupCount:3,backupZip:!0,level:Level.all,disabledConsole:!1,autoRewrite:!1,useConfig:!1,autoInitOption:!0};class ConsoleBuilder extends Map{constructor(e){super(),globalThis.__console=globalThis.console;var o=path.resolve();this.set("basePath",o),this.set("option",e),(e?.useConfig??defaultOption.useConfig)&&this.configResolver(e?.configFileName||defaultOption.configFileName),(e?.autoInitOption??defaultOption.autoInitOption)&&this.initOption(this.option)}get base(){return this.get("basePath")}get option(){return this.get("option")}get logger(){return this.get("logger")}get console(){return globalThis.__console}get log4js(){return log4js}onLog(e){this.set("on_log",e)}onInfo(e){this.set("on_info",e)}onError(e){this.set("on_error",e)}onWarn(e){this.set("on_warn",e)}onDebug(e){this.set("on_debug",e)}hookingStart(e){const o=this.get("on_"+e);if(o)return o(this.console,this.logger)}hookingEnd(e,o){!this.get("on_"+e)||"[object Function]"!==Object.prototype.toString.call(o[e])&&"[object AsyncFunction]"!==Object.prototype.toString.call(o[e])||o[e](this.console,this.logger)}configResolver(e){try{var o=require(path.join(this.base,e??"cw.config.js")),t={...this.option,...o.option};this.set("option",t)}catch(e){console.log(e)}}initOption(o){if((o=void 0===o?this.option:o)?.configLog4js)o.configLog4js(log4js,e=>{this.set("logger",e)},this.rewriteConsole.bind(this));else if(o?.backup){let e=".log";const i=o.fileName||defaultOption.fileName,r=i.split(".");1<r.length&&(e="."+r.pop());var t=r.join("."),t=(configure({appenders:{loggerStore:{type:"multiFile",base:(o?.logDir??defaultOption.logDir)+"/",property:"categoryName",extension:e,maxLogSize:o?.backupSize??defaultOption.backupSize,backups:o?.backupCount??defaultOption.backupCount,compress:o?.backupZip??defaultOption.backupZip}},categories:{default:{appenders:["loggerStore"],level:o?.level||defaultOption.level}}}),getLogger(t));this.set("logger",t),(o?.autoRewrite??defaultOption.autoRewrite)&&this.rewriteConsole()}else{configure({appenders:{loggerStore:{type:"file",filename:path.join(o?.logDir||defaultOption.logDir,o?.fileName||defaultOption.fileName)}},categories:{default:{appenders:["loggerStore"],level:o?.level||defaultOption.level}}});t=getLogger();this.set("logger",t),(o?.autoRewrite??defaultOption.autoRewrite)&&this.rewriteConsole()}return this}output(e,o){var t=this;"log"===e||"info"===e?t.logger.info(...o):"error"===e||"exception"===e?t.logger.error(...o):"warn"===e?t.logger.warn(...o):"debug"===e&&t.logger.debug(...o)}logWriter(t,e){const i=this;return function(...r){if(0!==r.length){const o=r[0];if("string"==typeof o&&["%o","%O","%d","%i","%s","%f"].some(e=>0<=o.indexOf(e))){let i=1;o.replaceAll(/(%o)|(%O)|(%d)|(%i)|(%s)|(%f)/g,(e,o)=>{var t=r[i];return i++,t})}else{var e=r.map(e=>"[object Number]"===Object.prototype.toString.call(e)||"[object Boolean]"===Object.prototype.toString.call(e)?String(e):"[object String]"===Object.prototype.toString.call(e)?e:"[object Undefined]"!==Object.prototype.toString.call(e)&&"[object Null]"!==Object.prototype.toString.call(e)&&("[object Object]"===Object.prototype.toString.call(e)||"[object Array]"===Object.prototype.toString.call(e))?JSON.stringify(e):String(e));i.output(t,e)}}}.bind(e||(this??null))}rewriteConsole(){const n=this;return globalThis.console=new Proxy(this.console,{get(i,r,e){return consoleProperty[r]?(...e)=>{var o=n.hookingStart(r);n.logWriter(r,i)(...e);let t=void 0;return t=n.option?.disabledConsole?void 0:i[r].call(i,...e),n.hookingEnd(r,{[r]:o}),t}:Reflect.get(i,r,e)}}),n}}exports.ConsoleBuilder=ConsoleBuilder;const auto=()=>{const e=new ConsoleBuilder({useConfig:!0,autoInitOption:!1,autoRewrite:!1});return e.initOption().rewriteConsole(),e};exports.auto=auto;
