Object.defineProperty(exports,"__esModule",{value:!0}),exports.auto=exports.ConsoleBuilder=exports.Level=void 0;const log4js=require("log4js"),path=require("path"),consoleProperty={log:!0,info:!0,error:!0,exception:!0,warn:!0,debug:!0,assert:!1,clear:!1,context:!1,count:!1,countReset:!1,dir:!1,dirxml:!1,group:!1,groupCollapsed:!1,groupEnd:!1,memory:!1,profile:!1,profileEnd:!1,table:!1,time:!1,timeEnd:!1,timeLog:!1,timeStamp:!1,trace:!1},{configure,getLogger}=log4js;var Level;!function(e){e.all="all",e.debug="debug",e.info="info",e.warn="warn",e.error="error",e.off="off"}(Level=exports.Level||(exports.Level={}));const defaultOption={backup:!0,fileName:"console.log",logDir:"logs",backupSize:10485760,backupCount:3,backupZip:!0,level:Level.all,disabledConsole:!1,autoRewrite:!1,useConfig:!1,autoInitOption:!0,configFileName:"cw.config.js"};class ConsoleBuilder extends Map{constructor(e){super(),globalThis.__console=globalThis.console;var t=path.resolve();this.set("basePath",t),this.set("option",e),(e?.useConfig??defaultOption.useConfig)&&this.configResolver(e?.configFileName||defaultOption.configFileName),(e?.autoInitOption??defaultOption.autoInitOption)&&this.initOption(this.option)}get base(){return this.get("basePath")}get option(){return this.get("option")}get logger(){return this.get("logger")}get console(){return globalThis.__console}get log4js(){return log4js}onLog(e){this.set("on_log",e)}onInfo(e){this.set("on_info",e)}onError(e){this.set("on_error",e)}onWarn(e){this.set("on_warn",e)}onDebug(e){this.set("on_debug",e)}hookingStart(e){const t=this.get("on_"+e);if(t)return t(this.console,this.logger)}hookingEnd(e,t){!this.get("on_"+e)||"[object Function]"!==Object.prototype.toString.call(t[e])&&"[object AsyncFunction]"!==Object.prototype.toString.call(t[e])||t[e](this.console,this.logger)}configResolver(e){try{var t=require(path.join(this.base,e??defaultOption.configFileName)),o={...this.option,...t.option};this.set("option",o)}catch(e){console.log(e)}}initOption(t){if(globalThis.console=this.console,(t=void 0===t?this.option:t)?.configLog4js)t.configLog4js(log4js,e=>{this.set("logger",e)},this.rewriteConsole.bind(this));else if(t?.backup){let e=".log";const i=t.fileName||defaultOption.fileName,r=i.split(".");1<r.length&&(e="."+r.pop());var o=r.join("."),o=(configure({appenders:{loggerStore:{type:"multiFile",base:(t?.logDir??defaultOption.logDir)+"/",property:"categoryName",extension:e,maxLogSize:t?.backupSize??defaultOption.backupSize,backups:t?.backupCount??defaultOption.backupCount,compress:t?.backupZip??defaultOption.backupZip}},categories:{default:{appenders:["loggerStore"],level:t?.level||defaultOption.level}}}),getLogger(o));this.set("logger",o),(t?.autoRewrite??defaultOption.autoRewrite)&&this.rewriteConsole()}else{configure({appenders:{loggerStore:{type:"file",filename:path.join(t?.logDir||defaultOption.logDir,t?.fileName||defaultOption.fileName)}},categories:{default:{appenders:["loggerStore"],level:t?.level||defaultOption.level}}});o=getLogger();this.set("logger",o),(t?.autoRewrite??defaultOption.autoRewrite)&&this.rewriteConsole()}return this}output(e,t){var o=this;"log"===e||"info"===e?o.logger.info(...t):"error"===e||"exception"===e?o.logger.error(...t):"warn"===e?o.logger.warn(...t):"debug"===e&&o.logger.debug(...t)}logWriter(o,e){const i=this;return function(...r){if(0!==r.length){const t=r[0];if("string"==typeof t&&["%o","%O","%d","%i","%s","%f"].some(e=>0<=t.indexOf(e))){let i=1;t.replaceAll(/(%o)|(%O)|(%d)|(%i)|(%s)|(%f)/g,(e,t)=>{var o=r[i];return i++,o})}else{var e=r.map(e=>{if("[object Number]"===Object.prototype.toString.call(e))return String(e);if("[object Boolean]"===Object.prototype.toString.call(e))return String(e);if("[object String]"===Object.prototype.toString.call(e))return e;if("[object Undefined]"===Object.prototype.toString.call(e))return String(e);if("[object Null]"===Object.prototype.toString.call(e))return String(e);if("[object Object]"===Object.prototype.toString.call(e))try{return JSON.stringify(e)}catch(e){return""}else{if("[object Array]"!==Object.prototype.toString.call(e))return String(e);try{return JSON.stringify(e)}catch(e){return""}}});i.output(o,e)}}}.bind(e||(this??null))}rewriteConsole(){const n=this;return globalThis.console=new Proxy(this.console,{get(i,r,e){return consoleProperty[r]?(...e)=>{var t=n.hookingStart(r);n.logWriter(r,i)(...e);let o=void 0;return o=n.option?.disabledConsole?void 0:i[r].call(i,...e),n.hookingEnd(r,{[r]:t}),o}:Reflect.get(i,r,e)}}),n}}exports.ConsoleBuilder=ConsoleBuilder;const auto=()=>{const e=new ConsoleBuilder({useConfig:!0,autoInitOption:!1,autoRewrite:!1});return e.initOption().rewriteConsole(),e};exports.auto=auto;
